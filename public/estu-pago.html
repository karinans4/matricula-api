<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estudiante – Pago de matrícula</title>
<link rel="stylesheet" href="/styles.css">
<script src="https://js.stripe.com/v3"></script>
<style>
  .grid{display:grid;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
  .right{text-align:right}
  .pill{font-size:.8rem;padding:2px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
  .mono{font-variant-numeric: tabular-nums;}
  .label{font-size:.9rem;opacity:.9;margin-bottom:4px}
  .field{padding:10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:transparent}
</style>
</head><body>
  <div class="card" style="max-width:1000px">
    <div class="row" style="justify-content:space-between">
      <h1>Pago de matrícula</h1>
      <a class="btn" id="volver" style="width:auto" href="/dashboard.html">Volver</a>
    </div>
    <p class="sub" id="bienvenida"></p>

    <!-- Paso 1: seleccionar matrícula -->
    <div class="card" style="background:transparent">
      <h3>Seleccionar matrícula</h3>
      <div class="row">
        <div class="input">
          <label class="label">Matrícula ID</label>
          <input id="matId" type="number" placeholder="Ej: 7" min="1" class="field" style="width:200px">
        </div>
        <button class="btn" id="btnCotizar">Cotizar</button>
        <span id="matInfo" class="pill"></span>
      </div>
      <div class="msg" id="msg"></div>
    </div>

    <!-- Paso 2: resumen de cobro -->
    <div class="card" style="background:transparent">
      <h3>Resumen</h3>
      <table>
        <tbody id="resumen">
          <tr><td>Costo de matrícula</td><td class="right mono" id="costoMat">—</td></tr>
          <tr><td>Créditos inscritos</td><td class="right mono"><span id="cred">0</span></td></tr>
          <tr><td>Precio por crédito</td><td class="right mono" id="precioCred">—</td></tr>
          <tr><td>Subtotal créditos</td><td class="right mono" id="subCred">—</td></tr>
          <tr><td><strong>Total a pagar</strong></td><td class="right mono"><strong id="total">—</strong></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Paso 3: datos de tarjeta (Stripe Elements) -->
    <div class="card" style="background:transparent">
      <h3>Datos de la tarjeta</h3>
      <div class="grid">
        <div>
          <label class="label">Nombre en la tarjeta</label>
          <input id="cardholder" class="field" placeholder="Como aparece en la tarjeta" style="width:100%" autocomplete="cc-name">
        </div>

        <div>
          <label class="label">Número de tarjeta</label>
          <div id="card-number" class="field" aria-label="Número de tarjeta"></div>
        </div>

        <div class="row" style="gap:14px">
          <div style="flex:1">
            <label class="label">Vencimiento</label>
            <div id="card-expiry" class="field" aria-label="Fecha de vencimiento"></div>
          </div>
          <div style="width:200px">
            <label class="label">CVV</label>
            <div id="card-cvc" class="field" aria-label="Código de seguridad"></div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnPagar" disabled>Pagar ahora</button>
          <span id="pagoInfo" class="pill"></span>
        </div>
        <div id="payMsg" class="msg"></div>
      </div>
    </div>

    <!-- Historial -->
    <div class="card" style="background:transparent">
      <h3>Mis pagos</h3>
      <table>
        <thead><tr>
          <th>#</th><th>Matrícula</th><th>Fecha</th><th>Estado</th><th class="right">Monto</th>
        </tr></thead>
        <tbody id="hist"></tbody>
      </table>
    </div>
  </div>

<script>
const API = (location.origin && location.origin.startsWith('http'))
  ? location.origin
  : 'https://matricula-api-s1rg.onrender.com';

const u = JSON.parse(localStorage.getItem('usuario')||'null');
const roles = (u?.roles || []);
const esEstudiante = roles.includes(3);
if (!u || !esEstudiante) location.href = '/';

document.getElementById('bienvenida').textContent = `Hola, ${u.nombre} (${u.correo})`;

const $=s=>document.querySelector(s);
const matIdInp = $('#matId'), btnCotizar = $('#btnCotizar'), matInfo = $('#matInfo');
const msg = $('#msg'), pagoInfo = $('#pagoInfo'), btnPagar = $('#btnPagar'), payMsg = $('#payMsg');
const costoMat = $('#costoMat'), cred = $('#cred'), precioCred = $('#precioCred'), subCred = $('#subCred'), total = $('#total');
const histT = $('#hist');

function show(t, ok=false){ msg.textContent=t||''; msg.className='msg '+(ok?'ok':'error'); }
function showPay(t, ok=false){ payMsg.textContent=t||''; payMsg.className='msg '+(ok?'ok':'error'); }
const fmtCRC = (n)=> new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC',maximumFractionDigits:2}).format(Number(n||0));

let estudiante = null;
let matricula_id = null;
let cot = null; // cotización actual
let pagoPendienteId = null;

// ===== Stripe Elements =====
let stripe, elements, cardNumber, cardExpiry, cardCvc;
let stripeReady = false;
let numOK=false, expOK=false, cvcOK=false;

async function fetchJSON(url, options){
  const r = await fetch(url, options);
  const ct = r.headers.get('content-type')||'';
  const data = ct.includes('application/json') ? await r.json() : null;
  if(!r.ok) throw new Error(data?.error || data?.mensaje || `HTTP ${r.status}`);
  return data;
}

function enablePayIfReady(){
  const nameOK = ($('#cardholder').value||'').trim().length>0;
  btnPagar.disabled = !(stripeReady && matricula_id && numOK && expOK && cvcOK && nameOK);
}

async function cargarEstudiante(){
  estudiante = await fetchJSON(`${API}/api/estudiantes/by-usuario/${u.id}`);
}

async function loadStripe(){
  try{
    const { pk } = await fetchJSON(`${API}/api/config/stripe-pk`);
    if (!pk) throw new Error('Stripe publishable key vacío (configurá STRIPE_PUBLISHABLE_KEY en el server).');
    stripe = Stripe(pk);
    elements = stripe.elements();

    cardNumber = elements.create('cardNumber');
    cardExpiry = elements.create('cardExpiry');
    cardCvc    = elements.create('cardCvc');

    cardNumber.mount('#card-number');
    cardExpiry.mount('#card-expiry');
    cardCvc.mount('#card-cvc');

    cardNumber.on('change', (e)=>{ numOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    cardExpiry.on('change', (e)=>{ expOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    cardCvc.on('change', (e)=>{ cvcOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    $('#cardholder').addEventListener('input', enablePayIfReady);

    stripeReady = true;
    enablePayIfReady();
  }catch(e){
    showPay(e.message || 'No fue posible inicializar el formulario de tarjeta.');
  }
}

function renderCotizacion(c){
  costoMat.textContent = fmtCRC(c.costo_matricula);
  cred.textContent = String(c.total_creditos||0);
  precioCred.textContent = fmtCRC(c.precio_credito||0);
  subCred.textContent = fmtCRC(c.subtotal_creditos||0);
  total.textContent = fmtCRC(c.monto_total||0);
}

async function cargarHistorial(){
  if(!estudiante?.id) return;
  const rows = await fetchJSON(`${API}/api/pagos/estudiante/${estudiante.id}`);
  histT.innerHTML = (rows||[]).map(p=>`
    <tr>
      <td>${p.id}</td>
      <td>${p.matricula_id}</td>
      <td>${new Date(p.fecha).toLocaleString()}</td>
      <td>${p.estado}</td>
      <td class="right mono">${fmtCRC(p.monto_total)}</td>
    </tr>
  `).join('') || `<tr><td colspan="5">Sin pagos aún.</td></tr>`;
}

async function cargarCotizacion(){
  show(''); pagoInfo.textContent=''; showPay('');
  const id = Number(matIdInp.value);
  if(!id){ show('Ingresá un ID de matrícula válido.'); return; }
  const c = await fetchJSON(`${API}/api/pagos/cotizacion/${id}`);
  cot = c; matricula_id = c.matricula_id;
  localStorage.setItem('matricula_id', String(matricula_id));
  matInfo.textContent = `Matrícula #${matricula_id}`;
  renderCotizacion(c);

  // estado del último pago (si hay)
  const p = await fetchJSON(`${API}/api/pagos/matricula/${matricula_id}`);
  if (p?.id){
    pagoPendienteId = p.id;
    pagoInfo.textContent = `Pago #${p.id} – ${p.estado}`;
  } else {
    pagoPendienteId = null;
    pagoInfo.textContent = '';
  }
  enablePayIfReady();
}

btnCotizar.addEventListener('click', async ()=>{
  try{ await cargarCotizacion(); await cargarHistorial(); show('', true); }
  catch(e){ show(e.message||String(e)); }
});

// Confirmar pago real con Stripe
btnPagar.addEventListener('click', async ()=>{
  try{
    showPay('');
    btnPagar.disabled = true;

    if(!matricula_id){ showPay('Cotizá primero.'); btnPagar.disabled=false; return; }
    if(!stripeReady || !numOK || !expOK || !cvcOK){ showPay('Completá los datos de la tarjeta.'); btnPagar.disabled=false; return; }

    // 1) crear PaymentIntent en backend (también asegura pago pendiente)
    const { clientSecret, pago_id } = await fetchJSON(`${API}/api/pagos/stripe/create-intent`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ matricula_id })
    });
    pagoPendienteId = pago_id;

    // 2) confirmar el pago con los datos de tarjeta (Elements)
    const cardholder = ($('#cardholder').value||'').trim();
    const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: cardNumber,
        billing_details: { name: cardholder }
      }
    });

    if (error) {
      showPay(error.message || 'No se pudo procesar el pago');
      btnPagar.disabled = false;
      return;
    }

    if (paymentIntent?.status === 'succeeded') {
      // 3) marcar como pagado en backend
      await fetchJSON(`${API}/api/pagos/${pagoPendienteId}/confirmar`, { method:'POST' });
      pagoInfo.textContent = `Pago #${pagoPendienteId} – Pagado`;
      showPay('Pago confirmado. ¡Gracias!', true);
      await cargarHistorial();
    } else {
      showPay('El pago no fue confirmado.');
      btnPagar.disabled = false;
    }
  } catch(e){
    showPay(e.message || String(e));
    btnPagar.disabled = false;
  }
});

// warm-up al volver
const volver = document.getElementById('volver');
volver.addEventListener('click', async (e)=>{
  e.preventDefault();
  for(let i=0;i<3;i++){ try{ const r=await fetch('/health',{cache:'no-store'}); if(r.ok) break; }catch{} await new Promise(r=>setTimeout(r,1200)); }
  location.href = volver.getAttribute('href');
});

// Init
(async function init(){
  try{
    await cargarEstudiante();
    await loadStripe();                 // monta los campos de tarjeta al cargar
    const q = new URLSearchParams(location.search);
    const mid = Number(q.get('matricula_id')) || Number(localStorage.getItem('matricula_id')) || 0;
    if(mid){ matIdInp.value = String(mid); await cargarCotizacion(); }
    await cargarHistorial();
  }catch(e){ show(e.message||String(e)); }
})();
</script>
</body></html>
