<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estudiante – Pago de matrícula</title>
<link rel="stylesheet" href="/styles.css">
<script src="https://js.stripe.com/v3"></script>
<style>
  .grid{display:grid;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
  .right{text-align:right}
  .pill{font-size:.8rem;padding:2px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
  .mono{font-variant-numeric: tabular-nums;}
  .label{font-size:.9rem;opacity:.9;margin-bottom:4px}
  .field{padding:10px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:transparent;width:100%}
  .two{display:grid;grid-template-columns:1fr 200px;gap:14px}
</style>
</head><body>
  <div class="card" style="max-width:1000px">
    <div class="row" style="justify-content:space-between">
      <h1>Pago de matrícula</h1>
      <a class="btn" id="volver" style="width:auto" href="/dashboard.html">Volver</a>
    </div>
    <p class="sub" id="bienvenida"></p>

    <!-- Paso 1: seleccionar matrícula -->
    <div class="card" style="background:transparent">
      <h3>Seleccionar matrícula</h3>
      <div class="row">
        <div class="input">
          <label class="label">Matrícula ID</label>
          <input id="matId" type="number" placeholder="Ej: 7" min="1" class="field" style="width:200px">
        </div>
        <button class="btn" id="btnCotizar">Cotizar</button>
        <span id="matInfo" class="pill"></span>
      </div>
      <div class="msg" id="msg"></div>
    </div>

    <!-- Paso 2: resumen de cobro -->
    <div class="card" style="background:transparent">
      <h3>Resumen</h3>
      <table>
        <tbody id="resumen">
          <tr><td>Costo de matrícula</td><td class="right mono" id="costoMat">—</td></tr>
          <tr><td>Créditos inscritos</td><td class="right mono"><span id="cred">0</span></td></tr>
          <tr><td>Precio por crédito</td><td class="right mono" id="precioCred">—</td></tr>
          <tr><td>Subtotal créditos</td><td class="right mono" id="subCred">—</td></tr>
          <tr><td><strong>Total a pagar</strong></td><td class="right mono"><strong id="total">—</strong></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Paso 3A: datos de tarjeta (Stripe Elements) -->
    <div class="card" style="background:transparent" id="card-section" hidden>
      <h3>Datos de la tarjeta</h3>
      <div class="grid">
        <div>
          <label class="label">Nombre en la tarjeta</label>
          <input id="cardholder" class="field" placeholder="Como aparece en la tarjeta" autocomplete="cc-name">
        </div>
        <div>
          <label class="label">Número de tarjeta</label>
          <div id="card-number" class="field" aria-label="Número de tarjeta"></div>
        </div>
        <div class="row" style="gap:14px">
          <div style="flex:1">
            <label class="label">Vencimiento</label>
            <div id="card-expiry" class="field" aria-label="Fecha de vencimiento"></div>
          </div>
          <div style="width:200px">
            <label class="label">CVV</label>
            <div id="card-cvc" class="field" aria-label="Código de seguridad"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paso 3B: datos de tarjeta (MOCK sin Stripe) -->
    <div class="card" style="background:transparent" id="mock-section" hidden>
      <h3>Datos de la tarjeta (simulado)</h3>
      <div class="grid">
        <div>
          <label class="label">Nombre en la tarjeta</label>
          <input id="m_cardholder" class="field" placeholder="Como aparece en la tarjeta" autocomplete="cc-name">
        </div>
        <div>
          <label class="label">Número de tarjeta</label>
          <input id="m_cardNumber" class="field" inputmode="numeric" maxlength="19" placeholder="1234 1234 1234 1234" autocomplete="cc-number">
        </div>
        <div class="two">
          <div>
            <label class="label">Vencimiento (MM/YY)</label>
            <input id="m_cardExp" class="field" inputmode="numeric" maxlength="5" placeholder="MM/YY" autocomplete="cc-exp">
          </div>
          <div>
            <label class="label">CVV</label>
            <input id="m_cardCvv" class="field" inputmode="numeric" maxlength="4" placeholder="123" autocomplete="cc-csc">
          </div>
        </div>
      </div>
    </div>

    <!-- Botón pagar + estado -->
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnPagar" disabled>Pagar ahora</button>
      <span id="pagoInfo" class="pill"></span>
    </div>
    <div id="payMsg" class="msg"></div>

    <!-- Historial -->
    <div class="card" style="background:transparent">
      <h3>Mis pagos</h3>
      <table>
        <thead><tr>
          <th>#</th><th>Matrícula</th><th>Fecha</th><th>Estado</th><th class="right">Monto</th>
        </tr></thead>
        <tbody id="hist"></tbody>
      </table>
    </div>
  </div>

<script>
const API = (location.origin && location.origin.startsWith('http'))
  ? location.origin
  : 'https://matricula-api-s1rg.onrender.com';

const u = JSON.parse(localStorage.getItem('usuario')||'null');
const roles = (u?.roles || []);
const esEstudiante = roles.includes(3);
if (!u || !esEstudiante) location.href = '/';

document.getElementById('bienvenida').textContent = `Hola, ${u.nombre} (${u.correo})`;

const $=s=>document.querySelector(s);
const matIdInp = $('#matId'), btnCotizar = $('#btnCotizar'), matInfo = $('#matInfo');
const msg = $('#msg'), pagoInfo = $('#pagoInfo'), btnPagar = $('#btnPagar'), payMsg = $('#payMsg');
const costoMat = $('#costoMat'), cred = $('#cred'), precioCred = $('#precioCred'), subCred = $('#subCred'), total = $('#total');
const histT = $('#hist');

function show(t, ok=false){ msg.textContent=t||''; msg.className='msg '+(ok?'ok':'error'); }
function showPay(t, ok=false){ payMsg.textContent=t||''; payMsg.className='msg '+(ok?'ok':'error'); }
const fmtCRC = (n)=> new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC',maximumFractionDigits:2}).format(Number(n||0));

let estudiante = null;
let matricula_id = null;
let cot = null; // cotización actual
let pagoPendienteId = null;

let mode = 'stripe'; // 'stripe' | 'mock'

// ===== Stripe Elements =====
let stripe, elements, cardNumber, cardExpiry, cardCvc;
let stripeReady = false;
let numOK=false, expOK=false, cvcOK=false;

// ===== MOCK inputs =====
function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
function m_validar(){
  const name = ($('#m_cardholder').value||'').trim();
  const num  = onlyDigits($('#m_cardNumber').value);
  const exp  = ($('#m_cardExp').value||'').trim();
  const cvv  = onlyDigits($('#m_cardCvv').value);
  const numOK = num.length >= 13 && num.length <= 19;
  const m = /^(\d{2})\/(\d{2})$/.exec(exp); let expOK = false;
  if (m){ const mm=Number(m[1]), yy=Number(m[2]); expOK = mm>=1 && mm<=12; }
  const cvvOK = cvv.length>=3 && cvv.length<=4;
  return { name, num, exp, cvv, ready: !!(name && numOK && expOK && cvvOK) };
}
['m_cardholder','m_cardNumber','m_cardExp','m_cardCvv'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', ()=>{
    if (id==='m_cardExp'){
      let v = el.value.replace(/[^\d]/g,'').slice(0,4);
      if (v.length>=3) v = v.slice(0,2)+'/'+v.slice(2);
      el.value = v;
    }
    if (id==='m_cardNumber'){
      el.value = onlyDigits(el.value).slice(0,19).replace(/(\d{4})(?=\d)/g,'$1 ');
    }
    enablePayIfReady();
  });
});

async function fetchJSON(url, options){
  const r = await fetch(url, options);
  const ct = r.headers.get('content-type')||'';
  const data = ct.includes('application/json') ? await r.json() : null;
  if(!r.ok) throw new Error(data?.error || data?.mensaje || `HTTP ${r.status}`);
  return data;
}

function enablePayIfReady(){
  if (!matricula_id) { btnPagar.disabled = true; return; }
  if (mode==='stripe'){
    const nameOK = ($('#cardholder').value||'').trim().length>0;
    btnPagar.disabled = !(stripeReady && numOK && expOK && cvcOK && nameOK);
  } else {
    const v = m_validar();
    btnPagar.disabled = !v.ready;
  }
}

async function cargarEstudiante(){
  estudiante = await fetchJSON(`${API}/api/estudiantes/by-usuario/${u.id}`);
}

async function initPayments(){
  try{
    const conf = await fetchJSON(`${API}/api/config/stripe-pk`).catch(()=>({pk:''}));
    const pk = conf?.pk || '';
    if (!pk){
      // MOCK MODE
      mode = 'mock';
      document.getElementById('mock-section').hidden = false;
      document.getElementById('card-section').hidden = true;
      stripeReady = true; // para habilitar botón cuando inputs mock estén OK
      enablePayIfReady();
      return;
    }
    // STRIPE MODE
    mode = 'stripe';
    document.getElementById('card-section').hidden = false;
    document.getElementById('mock-section').hidden = true;

    stripe = Stripe(pk);
    elements = stripe.elements();
    cardNumber = elements.create('cardNumber');
    cardExpiry = elements.create('cardExpiry');
    cardCvc    = elements.create('cardCvc');
    cardNumber.mount('#card-number');
    cardExpiry.mount('#card-expiry');
    cardCvc.mount('#card-cvc');

    cardNumber.on('change', (e)=>{ numOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    cardExpiry.on('change', (e)=>{ expOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    cardCvc.on('change', (e)=>{ cvcOK = !!e.complete; showPay(e.error?.message||''); enablePayIfReady(); });
    $('#cardholder').addEventListener('input', enablePayIfReady);

    stripeReady = true;
    enablePayIfReady();
  }catch(e){
    // Fallback a MOCK si falla
    mode = 'mock';
    document.getElementById('mock-section').hidden = false;
    document.getElementById('card-section').hidden = true;
    stripeReady = true;
    enablePayIfReady();
  }
}

function renderCotizacion(c){
  costoMat.textContent = fmtCRC(c.costo_matricula);
  cred.textContent = String(c.total_creditos||0);
  precioCred.textContent = fmtCRC(c.precio_credito||0);
  subCred.textContent = fmtCRC(c.subtotal_creditos||0);
  total.textContent = fmtCRC(c.monto_total||0);
}

async function cargarHistorial(){
  if(!estudiante?.id) return;
  const rows = await fetchJSON(`${API}/api/pagos/estudiante/${estudiante.id}`);
  histT.innerHTML = (rows||[]).map(p=>`
    <tr>
      <td>${p.id}</td>
      <td>${p.matricula_id}</td>
      <td>${new Date(p.fecha).toLocaleString()}</td>
      <td>${p.estado}</td>
      <td class="right mono">${fmtCRC(p.monto_total)}</td>
    </tr>
  `).join('') || `<tr><td colspan="5">Sin pagos aún.</td></tr>`;
}

async function cargarCotizacion(){
  show(''); pagoInfo.textContent=''; showPay('');
  const id = Number(matIdInp.value);
  if(!id){ show('Ingresá un ID de matrícula válido.'); return; }
  const c = await fetchJSON(`${API}/api/pagos/cotizacion/${id}`);
  cot = c; matricula_id = c.matricula_id;
  localStorage.setItem('matricula_id', String(matricula_id));
  matInfo.textContent = `Matrícula #${matricula_id}`;
  renderCotizacion(c);

  // último pago (si hay)
  const p = await fetchJSON(`${API}/api/pagos/matricula/${matricula_id}`).catch(()=>null);
  if (p?.id){
    pagoPendienteId = p.id;
    pagoInfo.textContent = `Pago #${p.id} – ${p.estado}`;
  } else {
    pagoPendienteId = null;
    pagoInfo.textContent = '';
  }
  enablePayIfReady();
}

btnCotizar.addEventListener('click', async ()=>{
  try{ await cargarCotizacion(); await cargarHistorial(); show('', true); }
  catch(e){ show(e.message||String(e)); }
});

// Pagar (Stripe real o MOCK)
btnPagar.addEventListener('click', async ()=>{
  try{
    showPay('');
    btnPagar.disabled = true;
    if(!matricula_id){ showPay('Cotizá primero.'); btnPagar.disabled=false; return; }

    if (mode==='stripe'){
      // 1) crear PaymentIntent en backend
      const { clientSecret, pago_id } = await fetchJSON(`${API}/api/pagos/stripe/create-intent`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ matricula_id })
      });
      pagoPendienteId = pago_id;

      // 2) confirmar con Elements
      const cardholder = ($('#cardholder').value||'').trim();
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: cardNumber,
          billing_details: { name: cardholder }
        }
      });
      if (error) { showPay(error.message || 'No se pudo procesar el pago'); btnPagar.disabled=false; return; }

      if (paymentIntent?.status === 'succeeded') {
        await fetchJSON(`${API}/api/pagos/${pagoPendienteId}/confirmar`, { method:'POST' });
        pagoInfo.textContent = `Pago #${pagoPendienteId} – Pagado`;
        showPay('Pago confirmado. ¡Gracias!', true);
        await cargarHistorial();
      } else {
        showPay('El pago no fue confirmado.');
        btnPagar.disabled = false;
      }
      return;
    }

    // MOCK: validar y confirmar directamente
    const v = m_validar();
    if (!v.ready){ showPay('Completá los datos de la tarjeta.'); btnPagar.disabled=false; return; }
    const brand = v.num.startsWith('4') ? 'visa' : v.num.startsWith('5') ? 'mastercard' : 'other';
    const last4 = v.num.slice(-4);

    const out = await fetchJSON(`${API}/api/pagos/mock/confirm`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ matricula_id, card_brand:brand, card_last4:last4 })
    });
    pagoInfo.textContent = `Pago #${out.pago_id} – Pagado`;
    showPay('Pago simulado confirmado.', true);
    await cargarHistorial();

  }catch(e){
    showPay(e.message || String(e));
  }finally{
    btnPagar.disabled = false;
  }
});

// warm-up al volver
const volver = document.getElementById('volver');
volver.addEventListener('click', async (e)=>{
  e.preventDefault();
  for(let i=0;i<3;i++){ try{ const r=await fetch('/health',{cache:'no-store'}); if(r.ok) break; }catch{} await new Promise(r=>setTimeout(r,1200)); }
  location.href = volver.getAttribute('href');
});

// Init
(async function init(){
  try{
    await cargarEstudiante();
    await initPayments();                 // decide Stripe vs MOCK y monta inputs
    const q = new URLSearchParams(location.search);
    const mid = Number(q.get('matricula_id')) || Number(localStorage.getItem('matricula_id')) || 0;
    if(mid){ matIdInp.value = String(mid); await cargarCotizacion(); }
    await cargarHistorial();
  }catch(e){ show(e.message||String(e)); }
})();
</script>
</body></html>
