<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel | Matrícula</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .grid{display:grid;gap:14px}
    .row{display:flex;gap:10px;justify-content:space-between;align-items:center}
    .card{max-width:920px}
    ul{margin:8px 0;padding-left:18px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.1);margin-left:6px;opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h1>Panel</h1>
      <button id="logout" class="btn" style="width:auto;background:linear-gradient(135deg,#fca5a5,#ef4444);color:#1f2937">Salir</button>
    </div>
    <p class="sub" id="bienvenida"></p>

    <div class="grid">
      <div>
        <h3>Navegación</h3>
        <ul id="menu"></ul>

        <h3 style="margin-top:18px">Accesos rápidos (demo)</h3>
        <ul>
          <li><a class="link" href="#" id="verPeriodos">Ver periodos activos</a></li>
          <li><a class="link" href="#" id="verTipos">Ver tipos de matrícula</a></li>
        </ul>
      </div>

      <pre id="result" style="white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.06);"></pre>
    </div>
  </div>

  <script>
    const API = location.origin;
    const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');

    // Guard: si no hay sesión, volver al login
    if (!usuario) {
      window.location.href = '/';
    }

    // Roles múltiples: [1=Admin, 2=Profesor, 3=Estudiante]
    const roles = Array.isArray(usuario.roles) ? usuario.roles : [];
    const esAdmin = roles.includes(1);
    const esProf  = roles.includes(2);
    const esEstu  = roles.includes(3);

    // Bienvenida + badges de roles (si roles_nombres viene del backend, lo usamos)
    const nombres = usuario.roles_nombres || roles.map(r => r===1?'Admin':r===2?'Profesor':'Estudiante');
    const badges = nombres.map(n => `<span class="badge">${n}</span>`).join('');
    document.querySelector('#bienvenida').innerHTML =
      `Hola, ${usuario.nombre} (${usuario.correo}) ${badges}`;

    // Cerrar sesión
    document.querySelector('#logout').onclick = () => {
      localStorage.removeItem('usuario');
      window.location.href = '/';
    };

    // Construir menú según roles (puede tener varios)
    const links = [];

    if (esAdmin) {
      links.push({ txt:'Administrar Profesores', href:'/admin-profesores.html' }); 
      links.push({ txt:'Administrar estudiantes', href:'/admin-estudiantes.html' });
      links.push({ txt:'Administrar Carreras', href:'/admin-carreras.html' });
      links.push({ txt:'Administrar Planes de estudio', href:'/admin-planes.html' });
      links.push({ txt:'Administrar Materias', href:'/admin-materias.html' });
      links.push({ txt:'Administrar Grupos', href:'/admin-grupos.html' });
      links.push({ txt:'Config. Académica – Periodos', href:'/admin-periodos.html' });
      links.push({ txt:'Config. Académica – Tipos de matrícula', href:'/admin-tipos.html' });
    }

    if (esEstu) {
      links.push({ txt:'Matrícula de materias', href:'/estu-matricula.html' });
      links.push({ txt:'Mis materias y notas', href:'/estu-notas.html' });
      links.push({ txt:'Pago de matrícula', href:'/estu-pago.html' });
    }

    if (esProf) {
      links.push({ txt:'Subir notas', href:'/prof-notas.html' });
    }

    // Evitar duplicados si tiene múltiples roles
    const uniqByHref = (arr) => {
      const seen = new Set();
      return arr.filter(i => (seen.has(i.href) ? false : seen.add(i.href)));
    };
    const finalLinks = uniqByHref(links);

    const menu = document.querySelector('#menu');
    menu.innerHTML = finalLinks.length
      ? finalLinks.map(l => `<li><a class="link" href="${l.href}">${l.txt}</a></li>`).join('')
      : '<li>No hay opciones para tu usuario aún.</li>';

    // Accesos rápidos de demo
    const result = document.querySelector('#result');

    document.querySelector('#verPeriodos')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      const r = await fetch(`${API}/api/periodos/activos`);
      result.textContent = JSON.stringify(await r.json(), null, 2);
    });

    document.querySelector('#verTipos')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      const r = await fetch(`${API}/api/tipos-matricula`);
      result.textContent = JSON.stringify(await r.json(), null, 2);
    });
  </script>
</body>
</html>
