<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estudiante – Matrícula</title>
<link rel="stylesheet" href="/styles.css">
<style>
  .grid{display:grid;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
  .pill{font-size:.8rem;padding:2px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
  .right{ text-align:right }
</style>
</head><body>
  <div class="card" style="max-width:1200px">
    <div class="row" style="justify-content:space-between">
      <h1>Matrícula de materias</h1>
      <a class="btn" id="volver" style="width:auto" href="/dashboard.html">Volver</a>
    </div>
    <p class="sub" id="bienvenida"></p>

    <!-- Paso 1: elegir periodo y tipo -->
    <div class="card" style="background:transparent">
      <h3>Configurar matrícula</h3>
      <div class="row">
        <div class="input">
          <label>Periodo</label>
          <select id="periodo"></select>
        </div>
        <div class="input">
          <label>Tipo de matrícula</label>
          <select id="tipo"></select>
        </div>
        <button class="btn" id="btnCrear">Usar/crear matrícula</button>
        <span id="matInfo" class="pill"></span>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <!-- Paso 2: oferta de grupos -->
    <div class="card" style="background:transparent">
      <h3>Oferta disponible</h3>
      <table>
        <thead><tr>
          <th>Cod</th><th>Materia</th><th>Profesor</th>
          <th>Horario</th><th class="right">Cupo</th><th></th>
        </tr></thead>
        <tbody id="oferta"></tbody>
      </table>
    </div>

    <!-- Paso 3: materias ya inscritas -->
    <div class="card" style="background:transparent">
      <h3>Mis materias en esta matrícula</h3>
      <table>
        <thead><tr>
          <th>Cod</th><th>Materia</th><th>Profesor</th><th>Horario</th><th></th>
        </tr></thead>
        <tbody id="inscritas"></tbody>
        <tfoot>
          <tr><td colspan="5" class="right"><strong>Total créditos: <span id="totCred">0</span></strong></td></tr>
        </tfoot>
      </table>
    </div>
  </div>

<script>
const API = (location.origin && location.origin.startsWith('http'))
  ? location.origin
  : 'https://matricula-api-s1rg.onrender.com';

const u = JSON.parse(localStorage.getItem('usuario')||'null');
const roles = (u?.roles || []);
const esEstudiante = roles.includes(3);
if (!u || !esEstudiante) location.href = '/';

document.getElementById('bienvenida').textContent = `Hola, ${u.nombre} (${u.correo})`;

const $=s=>document.querySelector(s);
const periodoSel=$('#periodo'), tipoSel=$('#tipo'), ofertaT=$('#oferta'), inscritasT=$('#inscritas');
const btnCrear=$('#btnCrear'), matInfo=$('#matInfo'), msg=$('#msg'), totCred=$('#totCred');

let estudiante, plan_id=null, matricula_id=null, detalleActual=[];

function show(t, ok=false){ msg.textContent=t; msg.className='msg '+(ok?'ok':'error'); }
function clearMsg(){ msg.textContent=''; msg.className='msg'; }
const esc = s => (s ?? '').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

// warm-up al volver
const volver = document.getElementById('volver');
volver.addEventListener('click', async (e)=>{
  e.preventDefault();
  for(let i=0;i<3;i++){ try{ const r=await fetch('/health',{cache:'no-store'}); if(r.ok) break; }catch{} await new Promise(r=>setTimeout(r,1200)); }
  location.href = volver.getAttribute('href');
});

async function fetchJSON(url, options){
  const r = await fetch(url, options);
  const ct = r.headers.get('content-type')||'';
  const data = ct.includes('application/json') ? await r.json() : null;
  if(!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
  return data;
}

function savePrefs(){
  localStorage.setItem('mat_pref', JSON.stringify({
    periodo: periodoSel.value,
    tipo: tipoSel.value
  }));
}
function loadPrefs(){
  try{
    const v = JSON.parse(localStorage.getItem('mat_pref')||'null');
    if (v?.periodo) periodoSel.value = String(v.periodo);
    if (v?.tipo)    tipoSel.value    = String(v.tipo);
  }catch{}
}

async function cargarBasicos(){
  // estudiante por usuario
  estudiante = await fetchJSON(`${API}/api/estudiantes/by-usuario/${u.id}`);
  plan_id = estudiante.plan_id;

  // periodos activos
  const periodos = await fetchJSON(`${API}/api/periodos/activos`);
  periodoSel.innerHTML = (periodos||[]).map(p=>`<option value="${p.id}">${esc(p.nombre)} (${esc(p.anio||p.year||'')})</option>`).join('');

  // tipos matrícula
  const tipos = await fetchJSON(`${API}/api/tipos-matricula`);
  tipoSel.innerHTML = (tipos||[]).map(t=>`<option value="${t.id}">${esc(t.descripcion)} – ₡${Number(t.costo||0).toFixed(2)}</option>`).join('');

  loadPrefs();
}

async function cargarOferta(){
  if(!plan_id) return;
  const pid = periodoSel.value;
  const data = await fetchJSON(`${API}/api/materias-impartidas?periodo_id=${pid}&plan_id=${plan_id}`);

  const inscritosIds = new Set(detalleActual.map(x => x.grupo_id));
  ofertaT.innerHTML = (data || []).map(g => {
    const gid = g.grupo_id ?? g.id;
    const prof = (g.profesor ?? [g.profesor_nombre, g.profesor_apellido].filter(Boolean).join(' ').trim()) || '—';
    const cupoAct = Number(g.cupo_actual ?? 0);
    const cupoMax = Number(g.cupo_maximo ?? 0);
    const disabled = (cupoAct >= cupoMax || inscritosIds.has(gid)) ? 'disabled' : '';
    const labelBtn = inscritosIds.has(gid) ? 'Ya inscrita' : 'Inscribir';

    return `
      <tr>
        <td>${esc(g.codigo ?? '')}</td>
        <td>${esc(g.materia ?? '')}</td>
        <td>${esc(prof)}</td>
        <td>${esc(g.horario ?? '')}</td>
        <td class="right">${cupoAct}/${cupoMax}</td>
        <td>
          <button class="btn insc" data-id="${gid ?? ''}" ${disabled}>${labelBtn}</button>
        </td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="6">No hay grupos para tu plan en este periodo.</td></tr>`;
}

function renderInscritas(){
  inscritasT.innerHTML = (detalleActual||[]).map(x=>`
    <tr>
      <td>${esc(x.codigo)}</td>
      <td>${esc(x.nombre)}</td>
      <td>${esc(`${x.profesor_nombre} ${x.profesor_apellido||''}`.trim())}</td>
      <td>${esc(x.horario||'')}</td>
      <td><button class="btn btn-quit" data-det="${x.detalle_id}">Quitar</button></td>
    </tr>
  `).join('') || `<tr><td colspan="5">Sin materias aún.</td></tr>`;

  const total = (detalleActual||[]).reduce((acc, it)=> acc + Number(it.creditos||0), 0);
  totCred.textContent = String(total);
}

async function cargarInscritas(){
  if(!matricula_id) {
    detalleActual = [];
    renderInscritas();
    return;
  }
  const det = await fetchJSON(`${API}/api/matricula/${matricula_id}/detalle`);
  detalleActual = det || [];
  renderInscritas();
}

btnCrear.addEventListener('click', async ()=>{
  clearMsg();
  try{
    savePrefs();
    const body = {
      estudiante_id: estudiante.id,
      periodo_id: Number(periodoSel.value),
      tipo_matricula_id: Number(tipoSel.value)
    };
    const out = await fetchJSON(`${API}/api/matricula/crear`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    if (out.ok==1 || out.ok===1 || out.matricula_id) {
      matricula_id = out.matricula_id;
      matInfo.textContent = `Matrícula #${matricula_id} (Pendiente)`;
      show(out.mensaje || 'Matrícula lista', true);
      await Promise.all([cargarInscritas(), cargarOferta()]);
    } else {
      show(out.mensaje || 'No se pudo crear la matrícula');
    }
  } catch(e){ show(e.message); }
});

// Inscribir desde la oferta
ofertaT.addEventListener('click', async (ev)=>{
  const t = ev.target;
  if (!t.classList.contains('insc')) return;
  if (!matricula_id) { show('Primero crea/usa la matrícula.', false); return; }

  const grupo_id = Number(t.dataset.id);

  // duplicado
  if (detalleActual.some(x => x.grupo_id === grupo_id)) {
    show('Esa materia ya está inscrita.', false);
    return;
  }
  // conflicto simple de horario por texto
  const grupo = [...ofertaT.querySelectorAll('button.insc')].find(b => Number(b.dataset.id)===grupo_id)?.closest('tr');
  const horarioNuevo = grupo ? grupo.children[3].textContent.trim() : '';
  if (horarioNuevo && detalleActual.some(x => (x.horario||'').trim() === horarioNuevo)) {
    show('Conflicto de horario con otra materia inscrita.', false);
    return;
  }

  try{
    const out = await fetchJSON(`${API}/api/matricula/agregar-detalle`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ matricula_id, materia_impartida_id: grupo_id })
    });
    if (out.ok==1 || out.ok===1){
      show(out.mensaje || 'Materia agregada', true);
      await Promise.all([cargarInscritas(), cargarOferta()]);
    } else {
      show(out.mensaje || 'No fue posible inscribir');
    }
  }catch(e){ show(e.message); }
});

// Quitar desde la lista
inscritasT.addEventListener('click', async (ev)=>{
  const t = ev.target;
  if (!t.classList.contains('btn-quit')) return;
  const detId = Number(t.dataset.det);
  if (!detId) return;

  try{
    const out = await fetchJSON(`${API}/api/matricula/detalle/${detId}`, { method:'DELETE' });
    if (out.deleted) {
      show('Materia quitada', true);
      await Promise.all([cargarInscritas(), cargarOferta()]);
    } else {
      show(out.error || 'No se pudo quitar la materia');
    }
  }catch(e){ show(e.message); }
});

// cambios de periodo recargan oferta
periodoSel?.addEventListener('change', ()=>{ savePrefs(); cargarOferta(); });

(async function init(){
  await cargarBasicos();
  await cargarOferta();
  await cargarInscritas();
})();
</script>
</body></html>
