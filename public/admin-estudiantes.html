<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin – Estudiantes</title>
<link rel="stylesheet" href="/styles.css">
</head><body>
  <div class="card" style="max-width:1100px">
    <div class="row">
      <h1>Estudiantes</h1>
      <a class="btn" id="volver" style="width:auto" href="/dashboard.html">Volver</a>
    </div>
    <p class="sub">Registro y mantenimiento de estudiantes</p>

    <!-- FORM: crear/editar estudiante -->
    <form id="f" class="form" style="grid-template-columns:repeat(8,1fr) auto;align-items:end">
      <div class="input"><label>Nombre</label><input id="nombre" required></div>
      <div class="input"><label>Apellido</label><input id="apellido"></div>
      <div class="input"><label>Carnet</label><input id="carnet" required></div>
      <div class="input"><label>Correo (estudiante)</label><input id="correo" type="email" required></div>
      <div class="input"><label>Dirección</label><input id="direccion"></div>
      <div class="input"><label>Cédula</label><input id="cedula"></div>

      <!-- Selector de usuario existente -->
      <div class="input" id="wrapUsuarioSel">
        <label>Usuario (existente)</label>
        <select id="usuario"></select>
      </div>

      <!-- Toggle: crear usuario nuevo -->
      <div class="input">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="crearUsuario"> Crear nuevo usuario
        </label>
      </div>

      <!-- Campos visibles solo si crearUsuario = true -->
      <div class="input" id="wrapUsuarioCorreo" style="display:none">
        <label>Correo (nuevo usuario)</label>
        <input id="usuarioCorreo" type="email" />
      </div>
      <div class="input" id="wrapUsuarioPass" style="display:none">
        <label>Contraseña (nuevo usuario)</label>
        <input id="usuarioPass" type="text" />
      </div>

      <div class="input"><label>Plan</label><select id="plan" required></select></div>
      <button class="btn" type="submit">Guardar</button>
    </form>

    <div id="msg" class="msg"></div>
    <div style="height:12px"></div>

    <!-- TABLA -->
    <table id="tbl" style="width:100%;border-collapse:collapse">
      <thead><tr>
        <th>ID</th><th>Nombre</th><th>Apellido</th><th>Carnet</th><th>Correo</th>
        <th>Dirección</th><th>Cédula</th>
        <th>Usuario</th><th>Plan</th><th>Acciones</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API = location.origin; // ← FALTA!
const u = JSON.parse(localStorage.getItem('usuario')||'null');
const roles = u?.roles || [];
const esAdmin = roles.includes(1);
if (!u || !esAdmin) location.href = '/';


const $ = sel => document.querySelector(sel);
const tblBody = $('#tbl tbody');
const f = $('#f');
const msg = $('#msg');

const nombre = $('#nombre');
const apellido = $('#apellido');
const carnet = $('#carnet');
const correo = $('#correo');
const direccion = $('#direccion');
const cedula = $('#cedula');
const usuarioSel = $('#usuario');
const crearUsuarioChk = $('#crearUsuario');
const usuarioCorreo = $('#usuarioCorreo');
const usuarioPass = $('#usuarioPass');
const planSel = $('#plan');

const wrapUsuarioSel = $('#wrapUsuarioSel');
const wrapUsuarioCorreo = $('#wrapUsuarioCorreo');
const wrapUsuarioPass = $('#wrapUsuarioPass');

function showMsg(text, ok=false){ msg.textContent = text; msg.className = 'msg ' + (ok ? 'ok' : 'error'); }
function clearMsg(){ msg.textContent=''; msg.className='msg'; }
function esc(s){ return (s ?? '').toString(); }

// Toggle crear usuario
crearUsuarioChk.addEventListener('change', ()=>{
  const creating = crearUsuarioChk.checked;
  wrapUsuarioSel.style.display = creating ? 'none' : '';
  wrapUsuarioCorreo.style.display = creating ? '' : 'none';
  wrapUsuarioPass.style.display = creating ? '' : 'none';
});

async function cargarOpciones(){
  try{
    const r = await fetch(`${API}/api/estudiantes/opciones`);
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const { usuarios, planes } = await r.json();
    usuarioSel.innerHTML = usuarios.map(x=>`<option value="${x.id}">${esc(x.label)}</option>`).join('');
    planSel.innerHTML    = planes.map(x=>`<option value="${x.id}">${esc(x.label)}</option>`).join('');
  }catch(e){ showMsg('No se pudieron cargar opciones: '+e.message); }
}

async function listar(){
  try{
    const r = await fetch(`${API}/api/estudiantes`);
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const data = await r.json();
    tblBody.innerHTML = data.map(x => `
      <tr>
        <td>${x.id}</td>
        <td>${esc(x.nombre)}</td>
        <td>${esc(x.apellido)}</td>
        <td>${esc(x.carnet)}</td>
        <td>${esc(x.correo)}</td>
        <td>${esc(x.direccion||'')}</td>
        <td>${esc(x.cedula||'')}</td>
        <td>${esc(x.usuario_correo || ('#'+x.usuario_id))}</td>
        <td>${esc(x.plan_nombre || ('Plan '+x.plan_id))}</td>
        <td>
          <button class="btn-edit"
            data-id="${x.id}"
            data-nombre="${esc(x.nombre)}"
            data-apellido="${esc(x.apellido||'')}"
            data-carnet="${esc(x.carnet)}"
            data-correo="${esc(x.correo)}"
            data-direccion="${esc(x.direccion||'')}"
            data-cedula="${esc(x.cedula||'')}"
            data-usuario="${x.usuario_id}"
            data-plan="${x.plan_id}"
            style="width:auto;padding:6px 10px">Editar</button>
          <button class="btn-del" data-id="${x.id}" style="width:auto;padding:6px 10px;margin-left:6px">Eliminar</button>
        </td>
      </tr>
    `).join('');
  }catch(e){ showMsg('Error al listar: '+e.message); }
}

// Delegación de eventos para editar/eliminar
tblBody.addEventListener('click', async (ev)=>{
  const t = ev.target;
  if (t.classList.contains('btn-edit')) {
    clearMsg();
    f.dataset.id = t.dataset.id;
    nombre.value     = t.dataset.nombre;
    apellido.value   = t.dataset.apellido;
    carnet.value     = t.dataset.carnet;
    correo.value     = t.dataset.correo;
    direccion.value  = t.dataset.direccion || '';
    cedula.value     = t.dataset.cedula || '';
    usuarioSel.value = String(t.dataset.usuario);
    planSel.value    = String(t.dataset.plan);
    crearUsuarioChk.checked = false;
    crearUsuarioChk.dispatchEvent(new Event('change'));
    showMsg(`Editando ID ${t.dataset.id}`, true);
  }
  if (t.classList.contains('btn-del')) {
    if (!confirm('¿Eliminar estudiante?')) return;
    try{
      const r = await fetch(`${API}/api/estudiantes/${t.dataset.id}`, { method:'DELETE' });
      const d = await r.json();
      d.deleted ? (showMsg('Eliminado', true), listar()) : showMsg(d.error || 'No se pudo eliminar');
    }catch(e){ showMsg('Error: '+e.message); }
  }
});

// Crear/Actualizar
f.addEventListener('submit', async (e)=>{
  e.preventDefault(); clearMsg();

  const creatingUser = crearUsuarioChk.checked;
  const payload = {
    nombre: nombre.value.trim(),
    apellido: apellido.value.trim(),
    carnet: carnet.value.trim(),
    correo: correo.value.trim(),
    direccion: direccion.value.trim(),
    cedula: cedula.value.trim(),
    plan_id: Number(planSel.value)
  };

  if (creatingUser) {
    payload.crear_usuario = true;
    payload.usuario_correo = usuarioCorreo.value.trim();
    payload.usuario_contrasena = usuarioPass.value.trim();
  } else {
    payload.usuario_id = Number(usuarioSel.value);
  }

  try{
    if (f.dataset.id) {
      // Para editar exigimos usuario existente (no alternar a "crear" en edición)
      if (!payload.usuario_id) return showMsg('Para editar, seleccione un usuario existente.');
      const r = await fetch(`${API}/api/estudiantes/${f.dataset.id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const d = await r.json();
      if (r.ok && d.updated) {
        showMsg('Actualizado', true);
        delete f.dataset.id; f.reset();
        crearUsuarioChk.checked = false; crearUsuarioChk.dispatchEvent(new Event('change'));
        listar();
      } else showMsg(d.error || `Error ${r.status}`);
    } else {
      const r = await fetch(`${API}/api/estudiantes`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const d = await r.json();
      if (r.ok && d.id) {
        showMsg('Creado', true); f.reset();
        crearUsuarioChk.checked = false; crearUsuarioChk.dispatchEvent(new Event('change'));
        listar();
      } else showMsg(d.error || `Error ${r.status}`);
    }
  }catch(e){ showMsg('Error: '+e.message); }
});

(async function init(){
  crearUsuarioChk.dispatchEvent(new Event('change'));
  await cargarOpciones();
  await listar();
})();

// -------- Warm-up antes de volver al dashboard --------
const volver = document.getElementById('volver');
volver.addEventListener('click', async (e)=>{
  e.preventDefault();
  const dest = volver.getAttribute('href');
  for (let i=0; i<3; i++) {
    try {
      const r = await fetch('/health', { cache:'no-store' });
      if (r.ok) break;
    } catch {}
    await new Promise(res=>setTimeout(res, 1200));
  }
  location.href = dest;
});
</script>
</body></html>
